## Práctica 4 - GitLab CI/CD (estructura final / guía)
##
## Este fichero NO contiene la solución “copiable”.
## Contiene la estructura final que deberías alcanzar tras completar los ejercicios,
## con comentarios indicando qué debes implementar en cada punto.
##
## Tu pipeline real debe ser: .gitlab-ci.yml

stages:
  - ci
  - cd

variables:
  # TODO (E2): Variables globales (recomendado: en GitLab CI/CD Variables)
  # IMAGE_REPO: "contrerasadr/devops-training-python-app"
  # REGISTRY_HOST: "local-registry:5000"
  # REGISTRY_REPO: "contrerasadr/devops-training-python-app"
  # COMPOSE_FILE: "docker-compose.yml"
  # COMPOSE_SERVICE: "app"
  # ENABLE_REGISTRY_PUSH: "true"
  # RUN_CD: "true"

ci:build:
  stage: ci
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "TODO: build CI image (devops/ci.Dockerfile)"
    - echo "TODO: run lint inside CI image"
    - echo "TODO: run tests inside CI image"
    - echo "TODO: docker build -t $IMAGE_NAME -f devops/Dockerfile ."
    - echo "TODO: optional push to registry"

cd:deploy:
  stage: cd
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  rules:
    # TODO (E5): Ejecutar si RUN_CD == "true" o rama develop/master
    - if: '$RUN_CD == "true"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never
  # TODO (E5): environment dinamico (master=PRO, resto=DEV)
  # environment:
  #   name: $ENV_NAME
  script:
    # Nota: en runner GitLab shared no hay registry local, se simula con build local.
    - echo "TODO: docker compose up -d"
    - echo "TODO: docker compose logs $COMPOSE_SERVICE"
  after_script:
    # TODO (E6): Cleanup garantizado
    - echo "TODO: docker compose down --volumes || true"
    - echo "TODO: docker rmi $IMAGE_NAME || true"
